\clearpage
\begin{lem}\label{lem:sub_sound}
1. If $ \Delta \models \sub{ \type }{ \type' } $ and $ \ienv \in \lrv{\Delta}$ and  $(\stepiA, \valr) \in \lrv{\ienv \type}$,  then  $(\stepiA, \valr) \in \lrv{\ienv \type'}$.
  \\
 2. If $ \Delta \models \sub{ \type }{ \type' } $ and $ \ienv \in
 \lrv{\Delta}$ and  $(\stepiA, (\env, \expr)) \in
 \lre{\dmap}{\nnatA}{\ienv \type}$, and $\dmap < \dmap'$ and $\nnatA < \nnatA' $,  then  $(\stepiA, (\env, \expr)) \in \lre{\dmap'}{\nnatA'}{\ienv \type'}$.
   \\
\end{lem}
%
\begin{proof} The proof of statement (1) is by induction on the
  subtying derivation.\\
\textbf{case}
\[ 
 \inferrule{
     \Delta \models \sub{\type_1 }{ \type_1'  } \\
         \Delta \models \sub{\type_2 }{ \type_2'  }
    }{
       \Delta \models \sub{\type_1 \times \type_2 }{ \type_1' \times \type_2'  }
    }
\]
Suppose we know : $ (\stepiA, (\valr_1, \valr_2)) \in \lrv{\ienv \type_1 \times \type_2} $.\\
TS:  $ (\stepiA, (\valr_1, \valr_2)) \in \lrv{\ienv \type_1' \times \type_2'} $ \\
Unfold its definition, we know: $  (\stepiA, \valr_1 ) \in \lrv{\ienv \type_1} $ and $  (\stepiA, \valr_2 ) \in \lrv{\ienv \type_2} $.\\
By IH on the first premise, we know: $  (\stepiA, \valr_1 ) \in \lrv{\ienv \type_1'} $.\\
By IH on the second premise, we know: $  (\stepiA, \valr_2 ) \in \lrv{\ienv \type_2'} $.\\
This case is proved.\\

\textbf{case}
\[
     \inferrule
    {
      \Delta  \models \sub{ \type_1' }{ \type_1 }
      \and
      \Delta  \models \sub{ \type_2 }{ \type_2' }
      \and
      \dmap \leq \dmap'
      \and
      \nnatA \leq \nnatA'
      \and 
      q \leq q'
    }
    {
      \Delta  \models \sub{ \tarr{\type_1}{\type_2}{ \nnatbiA }{\dmap}{\nnatA} }
      { \tarr{\type_1'}{\type_2'}{\nnatbiA'}{\dmap'}{\nnatA'} }
    }
\]
Suppose  $ (\stepiA, (\efix f(x).\expr, \env) ) \in \lrv{\ienv (\tarr{\type_1}{\type_2}{\nnatbiA}{\dmap}{\nnatA})  } ~(\star)$.\\
TS: $ (\stepiA, (\efix f(x).\expr, \env) ) \in \lrv{\ienv (\tarr{\type_1'}{\type_2'}{\nnatbiA'}{\dmap'}{\nnatA'})  } $ \\
From $(\star)$, we know:\\
$\forall \stepiB < \stepiA.\eapp  \forall (\stepiB, \valr) \in \lrv{\type_1}. $ \\
$ (\stepiB, (\env[x \mapsto \valr, f \mapsto (\efix f(x).\expr, \env)], \expr)) \in \lre{\dmap[x: \nnatbiA, f: \infty]}{\nnatA}{\type_2} $\\
STS:
$\forall \stepiB < \stepiA.\eapp  \forall (\stepiB, \valr') \in \lrv{\type_1'}. $ \\
$ (\stepiB, (\env[x \mapsto \valr', f \mapsto (\efix f(x).\expr, \env)], \expr)) \in \lre{\dmap'[x: \nnatbiA, f: \infty]}{\nnatA'}{\type_2'} ~(\diamond)$\\
Pick j, assume $(\stepiB, \valr') \in \lrv{\tau_1'}$, we also know $(\stepiB, \valr') \in \lrv{\tau_1}$ by IH on the first premise.\\
From $(\star)$, we know: \\
$ (\stepiB, (\env[x \mapsto \valr', f \mapsto (\efix f(x).\expr, \env)], \expr)) \in \lre{\dmap[x: \nnatbiA, f: \infty]}{\nnatA}{\type_2} $.\\
Unfold its definition, we get: \\
$ \forall \valr_t \eapp  \tr\eapp  \stepiB.\eapp \env[x \mapsto \valr', f \mapsto (\efix f(x).\expr, \env)], \expr \bigstep \valr_t, \tr  \conj (\size{\tr} = \stepiB) \conj (\stepiB \leq \stepiA)$\\
$\Rightarrow (\adap(\tr) \leq \nnatA \conj \forall x \in \mbox{Vars}.\eapp  \ddep{x}(\tr) \leq \dmap[x:\nnatbiA, f: \infty](x) \conj ((\stepiA - \stepiB,  \valr_t) \in \lrv{\type_2})$\\
Unfold $(\diamond)$, STS:
\begin{enumerate}
\item  $\adap(\tr) \leq \nnatA'$, It is proved because we know $\adap(\tr) \leq \nnatA $ and $\nnatA \leq \nnatA'$. \\
\item $\forall x \in \mbox{Vars}.\eapp  \ddep{x}(\tr) \leq \dmap'[x:\nnatbiA', f: \infty](x) $, because $\dmap \leq \dmap'$, It is proved using $\forall x \in \mbox{Vars}.\eapp  \ddep{x}(\tr) \leq \dmap[x:\nnatbiA, f: \infty](x) $ . \\
\item $((\stepiA - \stepiB,  \valr_t) \in \lrv{\type_2'})$ it is proved by IH on the second premise with $ ((\stepiA - \stepiB,  \valr_t) \in \lrv{\type_2})$. \\
\end{enumerate}


% \textbf{case}
% \[
%  \inferrule{
%        % \forall x \in \dmap'. \dmap'(x) =0
%     }{
%        \Delta \models \sub{\tbox{(
%           \tarr{\type_1}{\type_2}{\nnatbiA}{\dmap'}{\nnatA} )} 
%       }{\tarr{(\tbox{\type_1}) }{(\tbox{\type_2})}{0}{\dmap'}{0} }
%     }
% \]

\textbf{case}
\[
 \inferrule{
\dmap' \leq \dmap
    }{
       \Delta \models \sub{\tarr{\type_1}{\type_2}{0}{\dmap'}{0} }{  \tbox{(
          \tarr{\type_1}{\type_2}{\nnatbiA}{\dmap}{\nnatA} )  }
    } }
\]
Suppose  $ (\stepiA, (\efix f(x).\expr, \env) ) \in \lrv{\ienv (\tarr{\type_1}{\type_2}{0}{\dmap'}{0})  } ~(\star)$.\\
TS: $ (\stepiA, (\efix f(x).\expr, \env) ) \in \lrv{ \tbox{\ienv (\tarr{\type_1}{\type_2}{\nnatbiA}{\dmap}{\nnatA})  } } $ \\
Unfold its defintion, STS:\\
1. $ \delta \not \in  (\efix f(x).\expr, \env)$ . \wq{I do not know how to prove it.} \\
2.  $(\stepiA, (\efix f(x).\expr, \env) ) \in  \lrv{(\tarr{\type_1}{\type_2}{\nnatbiA}{\dmap}{\nnatA})}
$.  It can be proved from $(\star)$ because $ \Delta \models \sub{
  (\tarr{\type_1}{\type_2}{0}{\dmap'}{0})} {
  (\tarr{\type_1}{\type_2}{\nnatbiA}{\dmap}{\nnatA}) }  $ \\

\textbf{case}
\[
 \inferrule{
\dmap' \leq \dmap
    }{
       \Delta \models \sub{\tarr{\tbox{\type_1}}{\tbox{\type_2}}{0}{\dmap'}{0} }{  \tbox{(
          \tarr{\type_1}{\type_2}{\nnatbiA}{\dmap}{\nnatA} )  }
    } }
\]
Suppose  $ (\stepiA, (\efix f(x).\expr, \env) ) \in \lrv{\ienv
  (\tarr{\tbox{\type_1}}{\tbox{\type_2}}{0}{\dmap'}{0})  }
~(\star)$.\\
Unfold $(\star)$, we pick $\stepiB < \stepiA$ and $(\stepiB, \valr)
\in \lrv{\tbox{\type_1}}$. \\
We get:
 \[
   (\stepiB, (\env[x \mapsto \valr, f \mapsto (\efix f(x).\expr, \env)], \expr)) \in \lre{\dmap'[x: 0, f: \infty]}{0}{\tbox{\type_2}}
\]
Unrolling its defintion,\\
$ \forall \valr_t \eapp  \tr\eapp  \stepiB.\eapp \env[x \mapsto \valr, f \mapsto (\efix f(x).\expr, \env)], \expr \bigstep \valr_t, \tr  \conj (\size{\tr} = \stepiB) \conj (\stepiB \leq \stepiA)$\\
$\Rightarrow (\adap(\tr) \leq 0 \conj \forall x \in \mbox{Vars}.\eapp
\ddep{x}(\tr) \leq \dmap[x:0, f: \infty](x) \conj ((\stepiA - \stepiB,
\valr_t) \in \lrv{\tbox{ \type_2} })~(\diamond)$\\

TS: $ (\stepiA, (\efix f(x).\expr, \env) ) \in \lrv{ \tbox{\ienv
    (\tarr{\type_1'}{\type_2'}{\nnatbiA}{\dmap}{\nnatA})  } } $ \\
Unfold its defintion, STS:\\
1. $ \delta \not \in  (\efix f(x).\expr, \env)$ . \wq{I do not know how to prove it.} \\
2.  $(\stepiA, (\efix f(x).\expr, \env) ) \in  \lrv{(\tarr{\type_1}{\type_2}{\nnatbiA}{\dmap}{\nnatA})}
$. \\
   Use $\stepiB$ and $\valr$.\\
    STS:  \[
   (\stepiB, (\env[x \mapsto \valr, f \mapsto (\efix f(x).\expr, \env)], \expr)) \in \lre{\dmap[x: \nnatbiA, f: \infty]}{\nnatA}{\type_2}
\]
It is proved by $(\diamond)$.
 \\



\textbf{Case}
\[
\inferrule{
       % \forall x \in \dmap'. \dmap'(x) =0
    }{
       \Delta \models \sub{\tbox{(
          \tarr{\type_1}{\type_2}{\nnatbiA}{\dmap'}{\nnatA} )} 
      }{\tarr{(\tbox{\type_1}) }{(\tbox{\type_2})}{0}{\dmap'}{0} }
    }
\]
Assume $ \ienv \in \lrv{\Delta}$.\\
We have:  $$ (\stepiA, (\efix f(x).\expr, \env) ) \in \lrv{\ienv \tbox{(
          \tarr{\type_1}{\type_2}{\nnatbiA}{\dmap'}{\nnatA} )} }
      ~(\star)$$
TS: $ (\stepiA, (\efix f(x).\expr, \env) ) \in \lrv{ \ienv 
  \tarr{(\tbox{\type_1}) }{(\tbox{\type_2})}{0}{\dmap'}{0}} $ \\
Assume $\stepiB < \stepiA \conj (j, \valr) \in \lrv{\tbox{\type_1}}$,
which implies $ (j, \valr) \in \lrv{\type_1} \conj \delta \not \in \valr$ \\
STS: $(\stepiB, (\env[x \mapsto \valr, f \mapsto (\efix f(x).\expr,
\env)], \expr)) \in \lre{\dmap[x: 0, f:
  \infty]}{0}{ \tbox{ \type_2} } (\star\star)$\\

By unrolling $(\star)$, we know that: 
 $$ (\stepiA, (\efix f(x).\expr, \env) ) \in \lrv{\ienv (
          \tarr{\type_1}{\type_2}{\nnatbiA}{\dmap'}{\nnatA} ) } ~(a) \conj
        \delta \not \in   (\efix f(x).\expr, \env) ~(b)
      $$

By unrolling $(a)$ with $\stepiA < \stepiB \conj (j, \valr) \in
\lrv{\type_1}$, we get:
 \[
(\stepiB, (\env[x \mapsto \valr, f \mapsto (\efix f(x).\expr,
\env)], \expr)) \in \lre{\dmap'[x: \nnatbiA, f:
  \infty]}{\nnatA}{  \type_2 } (\diamond)
\]

Unrolling $(\diamond)$, assume \[ \env[x \mapsto \valr, f \mapsto (\efix f(x).\expr,
\env)], \expr \bigstep \valr_1, \tr_1 \conj |\tr_1| = \stepiB_1 \conj
\stepiB_1 \leq \stepiA \] .
We get : $$ \adap(\tr_1) \leq \nnatA $$
         $$\forall x \in \mbox{Vars}.\eapp  \ddep{x}(\tr_1) \leq
         \dmap'[x: \nnatbiA, f: \infty](x)$$
         $$  (\stepiA - \stepiB_1,  \valr_1) \in \lrv{\type_2}$$

Unrolling $(\star\star)$ with our assumption $ \env[x \mapsto \valr, f \mapsto (\efix f(x).\expr,
\env)], \expr \bigstep \valr_1, \tr_1 \conj |\tr_1| = \stepiB_1 \conj
\stepiB_1 \leq \stepiA $. \\ 
 STS:
\begin{enumerate}
\item $ \adap(\tr_1) \leq 0 $ \\  \wq{ have a lemma? :  if $\env, \expr
    \bigstep \valr,  \tr $ and $\delta \not \in \expr$ and $\delta \not
    \in \env$, then $ \adap(\tr)   = 0 $ and $\delta \not \in \valr $ }  
\item $\forall x \in \mbox{Vars}.\eapp  \ddep{x}(\tr_1) \leq
         \dmap'[x: 0, f: \infty](x)$ \\
\item $  (\stepiA - \stepiB_1,  \valr_1) \in \lrv{\tbox {\type_2} }$ \\
\end{enumerate}
  

\textbf{The proof of statement (2)} \\
Assume $(\stepiA, (\env, \expr)) \in
 \lre{\dmap}{\nnatA}{\ienv \type}~(\star)$. \\
%


TS: $(\stepiA, (\env, \expr)) \in
 \lre{\dmap'}{\nnatA'}{\ienv \type'}$.\\
Unfold its definition, STS:
$ \forall \stepiB, \env, \tr.  \env, \expr \bigstep \valr, \tr \conj
(\size{\tr} = \stepiB) \conj (\stepiB \leq \stepiA) $.\\
$\Rightarrow \adap(\tr) \leq \nnatA' \conj$\\
$\forall x \in \mbox{Vars}.\eapp  \ddep{x}(\tr) \leq \dmap'(x)\conj$\\
$ (\stepiA - \stepiB,  \valr) \in \lrv{\type'}$\\
%
Pick  $\stepiB$,$\valr$,  $\tr$, s.t.
$\env, \expr \bigstep \valr, \tr \conj
(\size{\tr} = \stepiB) \conj (\stepiB \leq \stepiA) $.\\
STS1: $\adap(\tr) \leq \nnatA' $ \\
STS2: $\forall x \in \mbox{Vars}.\eapp  \ddep{x}(\tr) \leq
\dmap'(x)$\\
STS3: $ (\stepiA - \stepiB,  \valr) \in \lrv{\type'}  $.\\


By inversion on the assumption $(\star)$, Pick $\stepiB$,$\valr$,
$\tr$. we know from assumption: $ \env, \expr \bigstep \valr, \tr \conj
(\size{\tr} = \stepiB) \conj (\stepiB \leq \stepiA) $.\\
We get: $\adap(\tr) \leq \nnatA ~(a)$\\
$\forall x \in \mbox{Vars}.\eapp  \ddep{x}(\tr) \leq \dmap(x)~(b)$\\
$ (\stepiA - \stepiB,  \valr) \in \lrv{\type}~(c)$\\

STS1: $\adap(\tr) \leq \nnatA' $ is proved by $(a)$ and $\nnatA \leq
\nnatA'$. \\
STS2: $\forall x \in \mbox{Vars}.\eapp  \ddep{x}(\tr) \leq
\dmap'(x)$. It is proved by $(b)$ and $\dmap \leq \dmap'$. \\
STS3: $ (\stepiA - \stepiB,  \valr) \in \lrv{\type'}$. It is proved by
IH1 instantiated with $(c)$  and $ \Delta \models \sub{\type}{\type'}$.\\


\end{proof}