We first Proved following Inversion Lemmas.
\input{thm_inversion}
\clearpage

\begin{thm}[Correctness]
\label{thm:alg_correct}
\[
\begin{array}{l}
  \forall \event_1, \event_2 \in \eventset^{\asn}, \trace, \in \mathcal{T}, D \in \dbdom , c \in \cdom \st
  \\ \quad 
   \forall l \in \mathcal{A}(\event_1, \event_2, \trace, c, D), z^i, y^j \in \lvar_c, l_h, l_t \st 
  \\ \qquad 
   \exists \trace' \in \mathcal{T} \st \trace = \event_1 \tracecat \trace' \cdot \event_2
   \implies 
   l = l_h ++ [z^i, y^j] ++ l_t 
   \implies \flowsto(z^i, y^j, c)
\end{array}
\]
\end{thm}

\begin{proof}[Proof of Theorem.~\ref{thm:alg_correct}].
Taking arbitrary $\event_1, \event_2 \in \eventset^{\asn}, \trace \in \mathcal{T}, D \in \dbdom , c \in \cdom$,
by strong induction on $\trace$, we have following cases.
\begin{case}($\trace = \cdot$)
\\
By definition of $\mathcal{A}$, we have
$\mathcal{A}(\event_1, \event_2, \cdot, c, D) = \{\}$.
\\
Since $\not\exists l \in \{\}$, the theorem is vacuously true.
\end{case}
%
\begin{case}($\trace = \cdot \event$)
\\
By definition of $\mathcal{A}$, we have
$\mathcal{A}(\event_1, \event_2, \cdot \event, c, D) = \{\}$.
\\
Since $\not\exists l \in \{\}$, the theorem is vacuously true.
\end{case}
%
\begin{case}($\trace = \event_1' \tracecat \trace_{ih} \land \trace_{ih} = \trace_{ih}' \cdot \event_2' \land 
(\event_1 \eventneq \event_1' \lor \event_2 \eventneq \event_2')$)
\\
By $(\event_1 \eventneq \event_1' \lor \event_2 \eventneq \event_2')$,
we know $\not\exists \trace' \in \mathcal{T}$ satisfies $
\event_1' \tracecat \trace_{ih}' \cdot \event_2' = \event_1 \tracecat \trace' \cdot \event_2$.
\\
The theorem is vacuously true.
\end{case}
%
%
\begin{case}
\label{case:alg_correct_base}
($\trace = \event_1 \tracecat \trace_{ih} \land \trace_{ih} = {} \cdot {} \event_2$)
\\
To show:
\[
\begin{array}{l}
   \forall l \in \mathcal{A}(\event_1, \event_1  {} \cdot {} \event_2, \trace, c, D), z^i, y^j \in \lvar_c, l_h, l_t \st 
  \\ \qquad 
   \exists \trace' \in \mathcal{T} \st 
   \event_1  {} \cdot {} \event_2 = \event_1 \tracecat \trace' \cdot \event_2
   \implies 
   l = l_h ++ [z^i, y^j] ++ l_t 
   \implies \flowsto(z^i, y^j, c)
\end{array}
\]
%
Let $\trace' = \cdot$, we know $\exists \trace' \in \mathcal{T}$ satisfying 
$\event_1  {} \cdot {} \event_2 = \event_1 \tracecat \trace' \cdot \event_2$.
\\
By Inversion Lemma~\ref{lem:inv_alg2}, we have either one of the two following cases:
\begin{enumerate}
  \item $\mathcal{A}(\event_1, \event_2, \event_1 \cdot \event_2, c, D) = 
  \left\{[\pi_1(\event_1)^{\pi_2(\event_1)}, \pi_1(\event_2)^{\pi_2(\event_2)}] \right \}$ 
  and $\eventdep^{val}(\event_1, \event_2, \event_1 \cdot \event_2, c)$.
  \item  $\mathcal{A}(\event_1, \event_2, \event_1 \cdot \event_2, c, D) = \{\}$ 
  and $\neg \eventdep^{val}(\event_1, \event_2, \event_1 \cdot \event_2, c)$;
\end{enumerate}
%
In case of $\mathcal{A}(\event_1, \event_2, \event_1 \cdot \event_2, c, D) = \{\}$,
since $\not\exists l \in \{\}$, the theorem is vacuously true.
%
\\
Then it is sufficient to show:
%
\[
  \eventdep^{val}(\event_1, \event_2, \event_1 \cdot \event_2, c) \implies \flowsto(\pi_1(\event_1)^{\pi_2(\event_1)}, \pi_1(\event_2)^{\pi_2(\event_2)}, c)
\]
% \input{alg_correct_base}
Proved in Subproof~\ref{pf:alg_correct_base}.

\end{case}
%
\begin{case}
[$\trace = \event_1 \tracecat \trace_{ih} \cdot \event_2 \land \trace_{ih} \neq \cdot$].
By strong induction, we have following induction hypothesis:
%
\[
\begin{array}{l}
  \forall \event_{ih1}, \event_{ih2} \eventin \trace_{ih} \cdot \event_2 \st
  \\ \quad 
   \forall l \in \mathcal{A}(\event_{ih1}, \event_{ih2}, \trace[\event_{ih1}:\event_{ih2}], c, D),  z^i, y^j \in \lvar_c, l_h, l_t \st 
   \\ \qquad
   \exists \trace_{m}' \in \mathcal{T} \st 
   \trace[\event_{ih1}:\event{ih2}] = \event_{ih1} \tracecat \trace_{m}' \cdot \event_{ih2}
   \implies l = l_h ++ [z^i, y^j] ++ l_t 
   \implies \flowsto(z^i, y^j, c)
   % \\
   % \implies
   % \forall l \in \mathcal{A}(\event_1, \event_2, \trace, c, D)  z^i, y^j \in \lvar_c, l_h, l_t \st
   % \\ \quad \qquad 
   % \exists \trace' \in \mathcal{T} \st \trace = \event_1 \tracecat \trace' \cdot \event_2
   % \implies l = l_h ++ [z^i, y^j] ++ l_t 
   % \implies \flowsto(z^i, y^j, c)  
\end{array}
\]
%
To show:
\[
\begin{array}{l}
  \forall \event_{ih1}, \event_{ih2} \eventin \trace_{ih} \cdot \event_2 \st
  \\ \quad 
   \forall l \in \mathcal{A}(\event_{ih1}, \event_{ih2}, \trace[\event_{ih1}:\event_{ih2}], c, D), z^i, y^j \in \lvar_c, l_h, l_t \st 
   \\ \qquad
   \exists \trace_{m}' \in \mathcal{T} \st 
   \trace[\event_{ih1}:\event{ih2}] = \event_{ih1} \tracecat \trace_{m}' \cdot \event_{ih2}
   \implies l = l_h ++ [z^i, y^j] ++ l_t 
   \implies \flowsto(z^i, y^j, c)
   \\
   \implies
   \forall l \in \mathcal{A}(\event_1, \event_2, \trace, c, D),  z^i, y^j \in \lvar_c, l_h, l_t \st
   \\ \quad \qquad 
   \exists \trace' \in \mathcal{T} \st \trace = \event_1 \tracecat \trace' \cdot \event_2
   \implies l = l_h ++ [z^i, y^j] ++ l_t 
   \implies \flowsto(z^i, y^j, c)  
\end{array}
\]
%
Let $\trace' = \trace_{ih}$, we know $\exists \trace' \in \mathcal{T}$ satisfying 
$\event_1  {}\tracecat \trace_{ih} \cdot {} \event_2 = \event_1 \tracecat \trace' \cdot \event_2$.
\\
Unfolding $\mathcal{A}(\event_1, \event_2, \trace, c, D)$, it is sufficient to show following 4 cases:
\begin{equation}
\begin{array}{l}
   \forall l \in \kw{dfs}(\trace, c, D), \event_z, \event_y \in \eventset^{\asn}, l_h, l_t \st 
   \\ \quad 
   l = l_h ++ [\event_z, \event_y] ++ l_t 
   \implies \flowsto(\pi_1(\event_z)^{\pi_2(\event_y)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)
\end{array}
\end{equation}
%
\begin{equation}
\begin{array}{l}
  \forall l \in \kw{dfs}(\trace, c, D), \event_z \in \eventset^{\asn}, \event_y \in \eventset^{\test}, l_h, l_t \st
   \\ \quad 
   l = l_h ++ [\event_z, \event_y] ++ l_t 
  \implies \pi_1(\event_z) \in VAR(\pi_1(\event_y))
\end{array}
\end{equation}
%
\begin{equation}
\begin{array}{l}
  \forall l \in \kw{dfs}(\trace, c, D), \event_z \in \eventset^{\test}, \event_y \in \eventset^{\asn}, l_h, l_t \st
   \\ \quad 
   l = l_h ++ [\event_z, \event_y] ++ l_t 
  \implies \forall z \in VAR(\pi_1(\event_z)) \st \exists i \in\mathbb{N} \st
  \flowsto(z^i, \pi_1(\event_y)^{\pi_2(\event_y)}, c)
\end{array}
\end{equation}
%
\begin{equation}
\begin{array}{l}
  \forall l \in \kw{dfs}(\trace, c, D), \event_z, \event_y \in \eventset^{\test}, l_h, l_t \st
   \\ \quad 
   l = l_h ++ [\event_z, \event_y] ++ l_t 
  \implies l_h ++ [\event_z] ++ l_t \in \kw{dfs}(\trace, c, D)
\end{array}
\end{equation}
%
\begin{subcase}($\event_z, \event_y \in \eventset^{\asn}$)
\\
Unfolding $\kw{dfs}(\trace, c, D)$, let $l$ be arbitrary $l \in  \kw{dfs}(\trace, c, D)$, it is sufficient to show 
\[
   \forall \event_z, \event_y \in \eventset^{\asn}, l_h, l_t \st 
   l = l_h ++ [\event_z, \event_y] ++ l_t 
   \implies \flowsto(\pi_1(\event_z)^{\pi_2(\event_y)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)
\] 
%
Proving by cases of $\event_z \eventeq \event_1 \lor \event_z \eventneq \event_1$.
\begin{subsubcase}[$\event_z \eventneq \event_1$]
Let $\event_z, \event_y \in \eventset^{\asn}, l_h, l_t$ be arbitrary events and lists such that:
\[
  l = l_h ++ [\event_z, \event_y] ++ l_t 
\]
%
Then it is sufficient to show $\flowsto(\pi_1(\event_z)^{\pi_2(\event_y)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)$.
\\
Unfolding $\kw{dfs}(\trace, c, D)$, we have:
%
\[
  l_h ++ [\event_z, \event_y] ++ l_t  \in 
     \bigcup\limits_{l \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D) }
  \left(  \eif \event_1 \stackrel{\trace}{\uplus} l \neq [] 
  \ethen \left\{ \event_1 \stackrel{\trace}{\uplus} l \right\} \eelse \left\{ l \right\}
  \right)
\]
%
\todo{which is sound and correct and easy to prove}
\[
  l_h ++ [\event_z, \event_y] ++ l_t  \in 
  \left(  \kw{dfs}(\trace_{ih} \cdot \event_2, c, D) \bigcup\limits_{l \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D) } \event_1 \stackrel{\trace}{\uplus} l 
  \right)
\]
%
By $\event_z \neq \event_1$, we have:
\[
  [\event_z, \event_y] ++ l_t \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D)
\]
%
% Let $\trace_{tl}$ be a subtrace  of $\trace$, such that: 
% $\trace[\event_z:] = \cdot \event_z \tracecat \trace_{tl}$, we know $\trace_{tl}$ is also a subtrace  of $\trace_{ih} \cdot \event_2$.
% \\
% Unfolding $\kw{dfs}(\trace, c, D)$, by $l_h ++ [\event_z, \event_y] ++ l_t  \in\kw{dfs}(\trace, c, D)$, we have:
% \[
% \begin{array}{l}
%   \exists l_{h}' \st l_{h}' ++ [\event_y] ++ l_t \in \kw{dfs}( \trace_{tl}, c, D) \st
%   (\event_z \stackrel{\trace[\event_z:]}{\uplus} l_{h}' ++ [\event_y] ++ l_t) = \{[\event_z, \event_y] ++ l_t\} 
%   \end{array}
% \]
% %
% Then
% we have
% \[
%   [\event_z, \event_y] ++ l_t 
%   \in \kw{dfs}(\trace[\event_z:], c, D)
% \]
%
%
By induction hypothesis on subtrace $\trace_{ih} \cdot \event_2$ and $[\event_z, \event_y] ++ l_t 
  \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D)$ we know:
\[
  \flowsto(\pi_1(\event_z)^{\pi_2(\event_z)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)
\]
This case is proved.
%
\end{subsubcase}
%
\begin{subsubcase}[$\event_z \eventeq \event_1$].
\\
Let $\event_y \in \eventset^{\asn}, l_h, l_t$ be arbitrary events and lists such that:
\[                                                                                                                                                                                                                                                                                                                                                                                                          
  l = l_h ++ [\event_z, \event_y] ++ l_t 
\]
%
Unfolding $\kw{dfs}(\trace, c, D)$, we have:
%
\[
  l_h ++ [\event_z, \event_y] ++ l_t  \in 
     \bigcup\limits_{l \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D) }
  \left(  \eif \event_1 \stackrel{\trace}{\uplus} l \neq [] 
  \ethen \left\{ \event_1 \stackrel{\trace}{\uplus} l \right\} \eelse \left\{ l \right\}
  \right)
  \]
By $\event_z \eventeq \event_1$, we know $l_h = []$ and 
% \[
%   [\event_1, \event_y] ++ l_t  \in 
%   \left( \bigcup\limits_{l \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D)} 
%   \event_1 \stackrel{\trace}{\uplus} l \right)
% \]
% %
% Then, we also know
% \[
%   \left( \bigcup\limits_{l \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D)} 
%   \event_1 \stackrel{\trace}{\uplus} l \right) \neq \emptyset
% \]
%
\[
\begin{array}{l}
  \exists l' \in \kw{dfs}(\trace_{ih}\cdot \event_2, c, D) \st
   (\event_1 \stackrel{\trace}{\uplus} l') \neq []
\end{array}
\]
%
% Unfolding $\left( \bigcup\limits_{l \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D)} 
%   \event_1 \stackrel{\trace}{\uplus} l \right)$, by 
Since $[\event_1, \event_y] ++ l_t $ belongs to this set, let $l' \in \kw{dfs}(\trace_{ih}\cdot \event_2, c, D)$ be the list such that:
\[
\begin{array}{l}
   (\event_1 \stackrel{\trace}{\uplus} l') = \{[\event_1, \event_y] ++ l_t\}
\end{array}
\]
%
Unfolding $(\event_1 \stackrel{\trace}{\uplus} l') $, we have:
\[
\begin{array}{l}
  \exists l_{h}' \st l' = l_{h}' ++ [\event_y] ++ l_t \in \kw{dfs}(\trace_{ih}\cdot \event_2, c, D) \st
  \eventdep^{val}(\event_1, \event_y, \trace[\event_1:\event_y], c, D)
  \\ \quad \land 
  (\forall \event_i \in l_{h}' \st \neg \eventdep^{val} (\event_1, \event_i, \trace[\event_1: \event_i], c, D))
\end{array}
\]
%
%
To show $\flowsto(\pi_1(\event_1)^{\pi_2(\event_1)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)$, 
\todo{need to insert the detail of unfolding}
%
by unfolding $\kw{dfs}(\trace_{ih}\cdot \event_2, c, D) $, we have:
\[
  \forall \event \in (\trace[\event_1:\event_y]\setminus \{\event_1, \event_y\}) 
 \land \event \notin l_h' 
 \st 
 \neg \eventdep^{val} (\event, \event_y, c, D)
\]
%
Since $l_{h}'$ is subset of $\trace[\event_1:\event_y] \setminus \{\event_1, \event_y\}$, and $(\forall \event_i \in l_{h}' \st \neg \eventdep^{val} (\event_1, \event_i, \trace[\event_1: \event_i], c, D))$,
then we know:
\[
  \forall \event \in (\trace[\event_1:\event_y]\setminus \{\event_1, \event_y\}) \st
  \neg \eventdep^{val} (\event_1, \event, c, D) \lor \neg \eventdep^{val} (\event, \event_y, c, D)
\]
%
Unfolding $\eventdep^{val}(\event_1, \event_y, \trace[\event_1:\event_y], c, D)$, we have:
\[
  \exists \event_1', \event_y' \in \eventset^{\asn},
  \trace' \in \mathcal{T}, c_1, c_2, c_2' \st
\]
%
\[
\config{c_1, \trace_1 \cdot \event_1} \rightarrow^{*} \config{c_2, \trace_1 \tracecat \trace[\event_1:\event_y]} 
\land
\config{c_1, \trace_1 \cdot \event_1'} \rightarrow^{*} \config{c_2', \trace_1 \tracecat \trace'[\event_1':\event_y']} 
\]
%
%
By inversion Lemma.~\ref{lem:inv_asn}, we have exists an expression $\expr$ or $\qexpr$ such that:
\[
\config{c_1, \trace_1 \cdot \event_1} \rightarrow^{*} \config{[\assign{\pi_1(\event_y)}{\expr / \query(\qexpr)}]{}^{\pi_2(\event_y)};c_2, \trace_1 \tracecat \trace'} \rightarrow^{asn / query} \config{c_2, \trace_1 \tracecat \trace[\event_1:\event_y]} 
\]
%
By $\forall \event \in (\trace[\event_1:\event_y]\setminus \{\event_1, \event_y\}) \st
  \neg \eventdep^{val} (\event_1, \event, c, D) \lor \neg \eventdep^{val} (\event, \event_y, c, D)$,
we know $\event_1$ is the only cause of the difference in $\event_y$ and $\event_y'$ when evaluating $[\assign{\pi_1(\event_y)}{\expr / \query(\qexpr)}]{}^{\pi_2(\event_y)}$.
%
\\
By inversion Lemma.~\ref{lem:inv_a} and ~\ref{lem:inv_eval_asn}, 
\[
  \pi_1(\event_1) \in VAR(\expr)
\]
%
By $\flowsto$ definition:
\[
  \flowsto(\pi_1(\event_1)^{\pi_2(\event_1)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)
\]
%
\end{subsubcase}
%
\end{subcase}
%
%
\begin{subcase}[ $l_h ++ {[\event_z, \event_b]} ++ l_t$ ].
%
\end{subcase}
%
\begin{subcase}[ $l_h ++ {[\event_b, \event_y]} ++ l_t$ ].
%
\end{subcase}
%
\begin{subcase}[ $l_h ++ {[\event_{b_1}, \cdots, \event_{b_n}]} ++ l_t$ ].
%
\end{subcase}
%
\end{case}
%
\end{proof}