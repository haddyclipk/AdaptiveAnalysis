\subsection{Inversion Lemmas}
We first Proved following Inversion Lemmas.
\input{thm_inversion}
\clearpage
\subsection{Main Correctness Theorem}
\begin{thm}[Correctness]
\label{thm:alg_correct}
\[
\begin{array}{l}
  \forall \event_1, \event_2 \in \eventset^{\asn}, \trace \in \mathcal{T}, D \in \dbdom , c \in \cdom \st
  \\ \quad 
   \exists \trace' \in \mathcal{T} \st \trace = \cdot \event_1 \tracecat \trace' \cdot \event_2
   \implies    \forall  z^i, y^j \in \lvar_c, l_h, l_t \st 
  \\ \qquad 
   l_h ++ [z^i, y^j] ++ l_t \in \mathcal{A}(\event_1, \event_2, \trace, c, D)
   \implies \flowsto(z^i, y^j, c)
\end{array}
\]
\end{thm}

\begin{proof}[Proof of Theorem.~\ref{thm:alg_correct}].
\\
Taking arbitrary $\event_1, \event_2 \in \eventset^{\asn}, \trace \in \mathcal{T}, D \in \dbdom , c \in \cdom$,
by strong induction on $\trace$, we have following cases.
\begin{case}($\trace = \cdot$)
\\
Since $\not\exists \trace' \in \mathcal{T}$,satisfies $
\cdot  = \cdot {} \event_1 \tracecat \trace' \cdot \event_2$, the theorem is vacuously true.
\end{case}
%
\begin{case}($\event \in \eventset, \trace = \cdot \event$)
\\
Since $\not\exists \trace' \in \mathcal{T}$,satisfies $
\cdot  \event = \cdot \event_1 \tracecat \trace' \cdot \event_2$, the theorem is vacuously true.
\end{case}
%
\begin{case}($\event_1', \event_2' \in \eventset, \trace_{ih} \in \mathcal{T}, 
\trace = \cdot \event_1' \tracecat \trace_{ih} \cdot \event_2' \land 
(\event_1 \eventneq \event_1' \lor \event_2 \eventneq \event_2')$)
\\
By $(\event_1 \eventneq \event_1' \lor \event_2 \eventneq \event_2')$,
we know $\not\exists \trace' \in \mathcal{T}$ satisfies $
\cdot \event_1' \tracecat \trace_{ih} \cdot \event_2' = \cdot \event_1 \tracecat \trace' \cdot \event_2$.
\\
The theorem is vacuously true.
\end{case}
%
%
\begin{case}
\label{case:alg_correct_base}
($\trace = \cdot {} \event_1 \cdot {} \event_2$)
\\
To show:
% \wq{$\forall l \in \mathcal{A}(\event_1, \event_2, \trace, c, D)$ below?}
%\jl{yes, there is a typo}
\[
\begin{array}{l}
  \exists \trace' \in \mathcal{T} \st \trace = \cdot \event_1 \tracecat \trace' \cdot \event_2
  \implies    
  \forall  z^i, y^j \in \lvar_c, l_h, l_t \st 
    \\ \qquad 
    l_h ++ [z^i, y^j] ++ l_t \in \mathcal{A}(\event_1, \event_2, \trace, c, D)
   \implies \flowsto(z^i, y^j, c)
\end{array}
\]
%
Let $\trace' = \cdot$, we know $\exists \trace' \in \mathcal{T}$ satisfying 
$\cdot {} \event_1  {} \cdot {} \event_2 = \cdot {} \event_1 \tracecat \trace' \cdot \event_2$.
\\
By Inversion Lemma~\ref{lem:inv_alg2}, we have either one of the two following cases:
\begin{enumerate}
  \item $\mathcal{A}(\event_1, \event_2, \cdot \event_1 \cdot \event_2, c, D) = 
  \left\{[\pi_1(\event_1)^{\pi_2(\event_1)}, \pi_1(\event_2)^{\pi_2(\event_2)}] \right \}$ 
  and $\eventdep^{val}(\event_1, \event_2, \cdot  \event_1 \cdot \event_2, c)$.
  \item  $\mathcal{A}(\event_1, \event_2, \cdot \event_1 \cdot \event_2, c, D) = \{\}$ 
  and $\neg \eventdep^{val}(\event_1, \event_2, \cdot  \event_1 \cdot \event_2, c)$;
\end{enumerate}
%
In case of $\mathcal{A}(\event_1, \event_2, \cdot \event_1 \cdot \event_2, c, D) = \{\}$,
since $\not\exists  z^i, y^j \in \lvar_c, l_h, l_t \st l_h ++ [z^i, y^j] ++ l_t \in \{\}$, the theorem is vacuously true.
%
\\
Then it is sufficient to show: 
% \wq{Because $l \in A \implies DEP$ }
% \jl{yes}
\[
  \eventdep^{val}(\event_1, \event_2, \cdot \event_1 \cdot \event_2, c) \implies \flowsto(\pi_1(\event_1)^{\pi_2(\event_1)}, \pi_1(\event_2)^{\pi_2(\event_2)}, c)
\]
%
Proved in Subproof~\ref{pf:alg_correct_base}.
\input{alg_correct_base}
%
\end{case}
%
\begin{case}
($\trace_{ih} \in \mathcal{T}, \trace = \event_1 \tracecat \trace_{ih} \cdot \event_2 \land \trace_{ih} \neq \cdot$)
\\
The induction hypothesis are as follows:
%
\[
\begin{array}{l}
  \forall \event_{ih1}, \event_{ih2} \eventin \trace_{ih} \cdot \event_2 \st
   \\ \quad
   \exists \trace' \in \mathcal{T} \st 
   \trace[\event_{ih1}:\event_{ih2}] = \event_{ih1} \tracecat \trace' \cdot \event_{ih2}
   \implies 
   \forall z^i, y^j \in \lvar_c, l_h, l_t \st 
    \\ \qquad 
   l_h ++ [z^i, y^j] ++ l_t  \in \mathcal{A}(\event_{ih1}, \event_{ih2}, \trace[\event_{ih1}:\event_{ih2}], c, D)
   \implies \flowsto(z^i, y^j, c)
   % \\ 
\end{array}
\]
%
To show:
\[
\begin{array}{l}
  % \forall \event_{ih1}, \event_{ih2} \eventin \trace_{ih} \cdot \event_2 \st
  %  \\ \quad
  %  \exists \trace' \in \mathcal{T} \st 
  %  \trace[\event_{ih1}:\event_{ih2}] = \event_{ih1} \tracecat \trace' \cdot \event_{ih2}
  %  \implies 
  %  \forall z^i, y^j \in \lvar_c, l_h, l_t \st 
  %   \\ \qquad 
  %  l_h ++ [z^i, y^j] ++ l_t  \in \mathcal{A}(\event_{ih1}, \event_{ih2}, \trace[\event_{ih1}:\event_{ih2}], c, D)
  %  \implies \flowsto(z^i, y^j, c)
  %  \\
  %  \implies
    \exists \trace' \in \mathcal{T} \st \trace = \event_1 \tracecat \trace' \cdot \event_2
   \implies \forall  z^i, y^j \in \lvar_c, l_h, l_t \st
   \\ \quad \qquad 
   l_h ++ [z^i, y^j] ++ l_t \in \mathcal{A}(\event_1, \event_2, \trace, c, D)
   \implies \flowsto(z^i, y^j, c)  
\end{array}
\]
%
Let $\trace' = \trace_{ih}$, we know $\exists \trace' \in \mathcal{T}$ satisfying 
$\event_1  {}\tracecat \trace_{ih} \cdot {} \event_2 = \event_1 \tracecat \trace' \cdot \event_2$.
\\
Taking arbitrary $z^i, y^j \in \lvar_c, l_h, l_t$ such that 
$l_h ++ [z^i, y^j] ++ l_t \in \mathcal{A}(\event_1, \event_2, \trace, c, D)$.
\\
By definition of $\mathcal{A}(\event_1, \event_2, \trace, c, D)$, 
we know there exists a preimage $l_e \in (\kw{dfs} \eapp \trace \eapp c \eapp  D )$ and two assignment events
$\event_z, \event_y \in \eventset^{\asn}$ such that $ \pi_1(\event_z)^{\pi_2(\event_y)} = z^i \land \pi_1(\event_y)^{\pi_2(\event_y)} = y^j$
and $l_e$ in following forms:
\\
\[
  \exists l_{he}, l_{te} \in List(\eventset) \st 
  l_e = l_{he} ++ [\event_z, \cdots, \event_y] ++ l_{te}
\]
, where $ \cdots $ between $\event_z, \event_y$ in $l_e$ represents $0$ or more testing events.
\\
% Unfolding $\mathcal{A}(\event_1, \event_2, \trace, c, D)$, it is sufficient to show following 4 cases:
By number of testing events between $\event_z, \event_y$ in $l_e$, it is sufficient to show following 3 cases:
\begin{equation}
\begin{array}{l}
  l_e = l_{he} ++ [\event_z, \event_y] ++ l_{te}
   \implies \flowsto(\pi_1(\event_z)^{\pi_2(\event_y)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)
\end{array}
\end{equation}
%
\begin{equation}
  \begin{array}{l}
    \forall \event_b \in \eventset^{\test}
    l_e = l_{he} ++ [\event_z, \event_b, \event_y] ++ l_{te}
     \implies \flowsto(\pi_1(\event_z)^{\pi_2(\event_y)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)
  \end{array}
  \end{equation}
%
%
\begin{equation}
\begin{array}{l}
  \forall n \in \mathbb{N}, \event_{b_1}, \cdots, \event_{b_n} \in \eventset^{\test}, l_h, l_t \st
   \\ \quad 
   n > 1 \implies
   l_e = l_{he} ++ {[\event_z, \event_{b_1}, \cdots, \event_{b_n}, \event_y]} ++ l_{te}
  \implies \flowsto(\pi_1(\event_z)^{\pi_2(\event_y)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)
\end{array}
\end{equation}
%
\begin{subcase}($l_e = l_{he} ++ [\event_z, \event_y] ++ l_{te}$)
\\
% Unfolding $\kw{dfs}(\trace, c, D)$, let $l$ be arbitrary $l \in  \kw{dfs}(\trace, c, D)$, it is sufficient to show 
% \[
%    \forall \event_z, \event_y \in \eventset^{\asn}, l_h, l_t \st 
%    l = l_h ++ [\event_z, \event_y] ++ l_t 
%    \implies \flowsto(\pi_1(\event_z)^{\pi_2(\event_y)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)
% \] 
By definition of $\kw{dfs}$, we have
%
\[
  l_{he} ++ [\event_z, \event_y] ++ l_{te}  \in 
  \left(  \kw{dfs}(\trace_{ih} \cdot \event_2, c, D) \cup
  \bigcup\limits_{l \in \kw{dfs} \eapp {\trace_{ih} \cdot \event_2} \eapp c \eapp D } (\uplus \eapp \event_1 \eapp \trace \eapp l)
  \right)
\]
We know either :
$l_{he} ++ [\event_z, \event_y] ++ l_{te}  \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D)$
\\
or $l_{he} ++ [\event_z, \event_y] ++ l_{te}  \in  
\bigcup\limits_{l \in \kw{dfs} \eapp {\trace_{ih} \cdot \event_2} \eapp c \eapp D } (\uplus \eapp \event_1 \eapp \trace \eapp l)$
\\
In case of $l_{he} ++ [\event_z, \event_y] ++ l_{te}  \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D)$, we know 
$\flowsto(\pi_1(\event_z)^{\pi_2(\event_y)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)$ by induction hypothesis.
\\
%
In case of $l_{he} ++ [\event_z, \event_y] ++ l_{te}  \in  
\bigcup\limits_{l \in \kw{dfs} \eapp {\trace_{ih} \cdot \event_2} \eapp c \eapp D } (\uplus \eapp \event_1 \eapp \trace \eapp l)$,
by definition of $\uplus$, we know there exists $l_{ih-he}$ such that
\[l_{ih-he} ++ [\event_y] ++ l_{te} \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D) \land 
\eventdep^{val}(\event_z, \event_y, \trace[\event_z:\event_y], c, D)\]
\\
Then we have 2 cases.
\begin{subsubcase}[$\event_z \eventneq \event_1$]
% Let $\event_z, \event_y \in \eventset^{\asn}, l_h, l_t$ be arbitrary events and lists such that:
% \[
%   l = l_h ++ [\event_z, \event_y] ++ l_t 
% \]
% %
% Then it is sufficient to show $\flowsto(\pi_1(\event_z)^{\pi_2(\event_y)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)$.
% \\
% By definition of $\kw{dfs}$, we have:
%
% \[
%   l_h ++ [\event_z, \event_y] ++ l_t  \in 
%      \bigcup\limits_{l \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D) }
%   \left(  \eif \event_1 \stackrel{\trace}{\uplus} l \neq [] 
%   \ethen \left\{ \event_1 \stackrel{\trace}{\uplus} l \right\} \eelse \left\{ l \right\}
%   \right)
% \]
% %
% \todo{which is sound and correct and easy to prove}

%
Since $\event_z \neq \event_1$, we know $\event_z, \event_y \in \trace_{ih} \cdot \event_2$.
\\
By definition of $\kw{dfs}$ and $\uplus$,  we also have:
\[
  [\event_z, \event_y] ++ l_{te} \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D) 
\]
%
% Let $\trace_{tl}$ be a subtrace  of $\trace$, such that: 
% $\trace[\event_z:] = \cdot \event_z \tracecat \trace_{tl}$, we know $\trace_{tl}$ is also a subtrace  of $\trace_{ih} \cdot \event_2$.
% \\
% Unfolding $\kw{dfs}(\trace, c, D)$, by $l_h ++ [\event_z, \event_y] ++ l_t  \in\kw{dfs}(\trace, c, D)$, we have:
% \[
% \begin{array}{l}
%   \exists l_{h}' \st l_{h}' ++ [\event_y] ++ l_t \in \kw{dfs}( \trace_{tl}, c, D) \st
%   (\event_z \stackrel{\trace[\event_z:]}{\uplus} l_{h}' ++ [\event_y] ++ l_t) = \{[\event_z, \event_y] ++ l_t\} 
%   \end{array}
% \]
% %
% Then
% we have
% \[
%   [\event_z, \event_y] ++ l_t 
%   \in \kw{dfs}(\trace[\event_z:], c, D)
% \]
%
%
By induction hypothesis on subtrace $\trace_{ih} \cdot \event_2$ and $[\event_z, \event_y] ++ l_t 
  \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D)$ we know:
\[
  \flowsto(\pi_1(\event_z)^{\pi_2(\event_z)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)
\]
This case is proved.
%
\end{subsubcase}
%
\begin{subsubcase}[$\event_z \eventeq \event_1$].
\\
% Let $\event_y \in \eventset^{\asn}, l_h, l_t$ be arbitrary events and lists such that:
% \[                                                                                                                                                                                                                                                                                                                                                                                                          
%   l = l_h ++ [\event_z, \event_y] ++ l_t 
% \]
% %
% Unfolding $\kw{dfs}(\trace, c, D)$, we have:
% %
% \[
%   l_h ++ [\event_z, \event_y] ++ l_t  \in 
%      \bigcup\limits_{l \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D) }
%   \left(  \eif \event_1 \stackrel{\trace}{\uplus} l \neq [] 
%   \ethen \left\{ \event_1 \stackrel{\trace}{\uplus} l \right\} \eelse \left\{ l \right\}
%   \right)
%   \]
By $\event_z \eventeq \event_1$, we know $l_{he} = []$ and 
% \[
%   [\event_1, \event_y] ++ l_t  \in 
%   \left( \bigcup\limits_{l \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D)} 
%   \event_1 \stackrel{\trace}{\uplus} l \right)
% \]
% %
% Then, we also know
% \[
%   \left( \bigcup\limits_{l \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D)} 
%   \event_1 \stackrel{\trace}{\uplus} l \right) \neq \emptyset
% \]
%
% \[
% \begin{array}{l}
%   \exists l_{ih} \in \kw{dfs}(\trace_{ih}\cdot \event_2, c, D) \st
%    (\event_1 \stackrel{\trace}{\uplus} l') \neq []
% \end{array}
% \]
% %
% % Unfolding $\left( \bigcup\limits_{l \in \kw{dfs}(\trace_{ih} \cdot \event_2, c, D)} 
% %   \event_1 \stackrel{\trace}{\uplus} l \right)$, by 
% Since $[\event_1, \event_y] ++ l_t $ belongs to this set, let $l' \in \kw{dfs}(\trace_{ih}\cdot \event_2, c, D)$ be the list such that:
\[
\begin{array}{l}
  \exists l_{ih} \in \kw{dfs}(\trace_{ih}\cdot \event_2, c, D) \st
   (\event_1 \stackrel{\trace}{\uplus} l_{ih}) = \{[\event_1, \event_y] ++ l_{te}\}
\end{array}
\]
%
By definition of $\uplus$, we have:
\[
\begin{array}{l}
  \exists l_{ih-h} \st  l_{ih} =  l_{ih-h} ++ [\event_y] ++ l_{te} \in \kw{dfs}(\trace_{ih}\cdot \event_2, c, D) \st
  \eventdep^{val}(\event_1, \event_y, \trace[\event_1:\event_y], c, D)
  \\ \quad \land 
  (\forall \event_i \in l_{ih-h} \st \neg \eventdep^{val} (\event_1, \event_i, \trace[\event_1: \event_i], c, D))
\end{array}
\]
%
%
To show $\flowsto(\pi_1(\event_1)^{\pi_2(\event_1)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)$, 
%
by unfolding $\kw{dfs}(\trace_{ih}\cdot \event_2, c, D)$, we have:(\todo{Proved by showing contrdiction: if $\eventdep^{val} (\event_i, \event_y, \trace[\event_i:\event_y], c, D)$, then $\event_i$ shows up 
in $l_{ih-h}$.})
\[
  \forall \event_i \in (\trace[\event_1:\event_y]\setminus \{\event_1, \event_y\}) 
 \land \event \notin l_{ih-h} 
 \st 
 \neg \eventdep^{val} (\event_i, \event_y, \trace[\event_i:\event_y], c, D)
\]
%
%
% Since $l_{h}'$ is subset of $\trace[\event_1:\event_y] \setminus \{\event_1, \event_y\}$, and $(\forall \event_i \in l_{h}' \st \neg \eventdep^{val} (\event_1, \event_i, \trace[\event_1: \event_i], c, D))$,
then we know:
\[
  \forall \event_i \in \trace[\event_1:\event_y] \st
  \neg \eventdep^{val} (\event_1, \event_i, \trace[\event_1: \event_i], c, D) 
  \lor \neg \eventdep^{val} (\event_i, \event_y,\trace[\event_i:\event_y], c, D)
\]
%
By Inversion Lemma~\ref{lem:inv_indepevents}, we have
\[
  \flowsto(\pi_1(\event_1)^{\pi_2(\event_1)}, \pi_1(\event_y)^{\pi_2(\event_y)}, c)
\]
%
\end{subsubcase}
%
\end{subcase}
%
%
\begin{subcase}[ $l_e = l_h ++ {[\event_z, \event_b, \event_y]} ++ l_t$ ].
\\
We proved following 2 sub lemmas for this case:
\begin{equation}
  \begin{array}{l}
    \forall \event_z \in \eventset^{\asn}, \event_y \in \eventset^{\test}, l_h, l_t \st
     \\ \quad 
     l_h ++ [\event_z, \event_y] ++ l_t \in \kw{dfs}(\trace, c, D)
    \implies \pi_1(\event_z) \in VAR(\pi_1(\event_y))
  \end{array}
  \end{equation}
  %
  \begin{equation}
  \begin{array}{l}
    \forall \event_z \in \eventset^{\test}, \event_y \in \eventset^{\asn}, l_h, l_t \st
     \\ \quad 
     l_h ++ [\event_z, \event_y] ++ l_t \in \kw{dfs}(\trace, c, D)
    \implies \forall z \in VAR(\pi_1(\event_z)) \st \exists i \in\mathbb{N} \st
    \flowsto(z^i, \pi_1(\event_y)^{\pi_2(\event_y)}, c)
  \end{array}
  \end{equation}
%
\end{subcase}
%
%
\begin{subcase}[ $l_e = l_h ++ {[\event_{b_1}, \cdots, \event_{b_n}]} ++ l_t$ ].
%
\\
We proved following lemma for this case:
\begin{equation}
  \begin{array}{l}
    \forall \event_z, \event_y \in \eventset^{\test}, l_h, l_t \st
     \\ \quad 
     l_h ++ [\event_z, \event_y] ++ l_t \in \kw{dfs}(\trace, c, D)
    \implies l_h ++ [\event_z] ++ l_t \in \kw{dfs}(\trace, c, D)
  \end{array}
  \end{equation}
\end{subcase}
%
\end{case}
%
\end{proof}