\documentclass[a4paper,11pt]{article}
\usepackage[table]{xcolor}



\input{prelude}
\input{ldefs}

\usepackage{tikz}
\usetikzlibrary{shapes,arrows}
\newcommand{\THESYSTEM}{\textsf{AdaptFun}}

% Define block styles
\tikzstyle{decision} = [diamond, draw, fill=blue!20, 
    text width=4.5em, text badly centered, node distance=3cm, inner sep=0pt]
\tikzstyle{block} = [rectangle, draw, fill=blue!20, 
    text width=5em, text centered, rounded corners, minimum height=4em]
\tikzstyle{line} = [draw, -latex']
\tikzstyle{cloud} = [draw, ellipse,fill=red!20, node distance=3cm,
    minimum height=2em]

\begin{document}


We first Proved following Inversion Lemmas.
\input{thm_inversion}
\clearpage

\begin{thm}[Correctness]
\label{thm:alg_correct}
\[
\begin{array}{l}
  \forall \event_1, \event_2 \in \eventset^{\asn}, \trace \in \mathcal{T}, D \in \dbdom , c \st
  \\ \quad 
   \forall l \in \mathcal{A}(\event_1, \event_2, \trace, c, D) \st
   \\ \quad 
   \forall z^i, y^j \in \lvar_c, l_h, l_t \st 
   l = l_h ++ [z^i, y^j] ++ l_t 
   \implies \flowsto(z^i, y^j)
\end{array}
\]
\end{thm}

\begin{proof}[Proof of Theorem.~\ref{thm:alg_correct}].
By strong induction on $\trace$:
\begin{case}
\label{case:alg_correct_base}
[$\trace = \event_1 \cdot \event_2$]
To show:
\[
\begin{array}{l}
  \forall \event_1, \event_2 \in \eventset^{\asn}, D \in \dbdom , c \st
  \\ \quad 
   \forall l \in \mathcal{A}( \event_1, \event_2,  \event_1 \cdot \event_2, c, D) \st
   \\ \quad 
   \forall z^i, y^j \in \lvar_c, l_h, l_t \st 
   l = l_h ++ [z^i, y^j] ++ l_t 
   \implies \flowsto(z^i, y^j)
\end{array}
\]
%
Unfolding $\mathcal{A}(\event_1, \event_2, \event_1 \cdot \event_2, c, D)$, it is sufficient to show:
%
\[
\begin{array}{l}
  \forall \event_1, \event_2 \in \eventset^{\asn}, D \in \dbdom , c \st
  \\ \quad 
   \forall l \in  \bigcup\limits_{l \in \kw{dfs}(\event_1 \cdot \event_2, c, D) \land l = \event_1 :: l'}
  \emap 
  % \\ \qquad \qquad
  (\efun : \event \to \pi_1(\event)^{\pi_2(\event)})  
  % \\ \qquad \qquad
  (\efilter 
    (\efun : \event \to  \event \in \eventset^{\asn}) ~ l)
 \st
   \\ \quad 
   \forall z^i, y^j \in \lvar_c, l_h, l_t \st 
   l = l_h ++ [z^i, y^j] ++ l_t 
   \implies \flowsto(z^i, y^j)
\end{array}
\]
%
Unfolding $\kw{dfs}(\event_1 \cdot \event_2, c, D)$, and $\event_1 \stackrel{\event_1 \cdot \event_2}{\uplus} [\event_2] $ we have:
\[
\begin{array}{l}
  \forall \event_1, \event_2 \in \eventset^{\asn}, D \in \dbdom , c \st
  \\ \quad 
   \forall l \in  \bigcup\limits_{l \in \{[\event_2]\} \cup
   (\eventdep^{val}(\event_1, \event_2, \event_1 \cdot \event_2, c) \to
       \{[\event_1, \event_2]\}) \land l = \event_1 :: l'}
  \emap 
  % \\ \qquad \qquad
  (\efun : \event \to \pi_1(\event)^{\pi_2(\event)})  
  % \\ \qquad \qquad
  (\efilter 
    (\efun : \event \to  \event \in \eventset^{\asn}) ~ l)
 \st
   \\ \quad 
   \forall z^i, y^j \in \lvar_c, l_h, l_t \st 
   l = l_h ++ [z^i, y^j] ++ l_t 
   \implies \flowsto(z^i, y^j)
\end{array}
\]
%
Simplifying $\emap$ and $\efilter$, it is sufficient to show:
\[
\begin{array}{l}
  \forall \event_1, \event_2 \in \eventset^{\asn}, D \in \dbdom , c \st
  \\ \quad 
   \forall l \in 
   (\eventdep^{val}(\event_1, \event_2, \event_1 \cdot \event_2, c) \to 
       \{[\pi_1(\event_1)^{\pi_2(\event_1)}, \pi_1(\event_2)^{\pi_2(\event_2)}], [\pi_1(\event_2)^{\pi_2(\event_2)}]\})
 \st
   \\ \quad 
   \forall z^i, y^j \in \lvar_c, l_h, l_t \st 
   l = l_h ++ [z^i, y^j] ++ l_t 
   \implies \flowsto(z^i, y^j)
\end{array}
\]
%
Then it is sufficient to show:
%
\[
  \eventdep^{val}(\event_1, \event_2, \event_1 \cdot \event_2, c) \implies \flowsto(\pi_1(\event_1)^{\pi_2(\event_1)}, \pi_1(\event_2)^{\pi_2(\event_2)})
\]
% \input{alg_correct_base}
Proved in Subproof~\ref{pf:alg_correct_base}.

\end{case}
%
\begin{case}
[$\trace = \event_1 \tracecat \trace_{ih} \cdot \event_2 \land \trace_{ih} \neq \cdot$]
by strong induction, we have following induction hypothesis:
%
\[
\begin{array}{l}
  \forall \event_{ih1}, \event_{ih2} \eventin \trace_{ih} \cdot \event_2, D \in \dbdom , c \st
  \\ \quad 
   \forall l \in \mathcal{A}(\event_{ih1}, \event_{ih2}, \trace[\event_{ih1}:\event_{ih2}], c, D) \st
   \\ \quad 
   \forall z^i, y^j \in \lvar_c, l_h, l_t \st 
   l = l_h ++ [z^i, y^j] ++ l_t 
   \implies \flowsto(z^i, y^j)
   \\
   \implies
   \forall D \in \dbdom , c \st
  \\ \quad 
   \forall l \in \mathcal{A}(\event_1, \event_2, \trace, c, D) \st
   \\ \quad 
   \forall z^i, y^j \in \lvar_c, l_h, l_t \st 
   l = l_h ++ [z^i, y^j] ++ l_t 
   \implies \flowsto(z^i, y^j)  
\end{array}
\]
%
Unfolding $\mathcal{A}(\event_{ih1}, \event_{2}, \trace[\event_{ih1}:], c, D)$ and $\mathcal{A}(\event_1, \event_2, \trace, c, D)$, there are 4 cases:
\begin{equation}
\begin{array}{l}
  \forall \event_{ih1}, \event_{ih2} \eventin \trace_{ih} \cdot \event_2, D \in \dbdom , c \st
  \\ \quad 
   \forall l \in \kw{dfs}(\trace[\event_{ih1}:\event_{ih2}], c, D) \st
   \\ \quad 
   \forall \event_z, \event_y \in \eventset^{\asn}, l_h, l_t \st 
   l = l_h ++ [\event_z, \event_y] ++ l_t 
   \implies \flowsto(\pi_1(\event_z)^{\pi_2(\event_y)}, \pi_1(\event_y)^{\pi_2(\event_y)})
   \\
   \implies
   \forall D \in \dbdom , c \st
  \\ \quad 
   \forall l \in \kw{dfs}(\trace, c, D) \st
   \\ \quad 
   \forall \event_z, \event_y \in \eventset^{\asn}, l_h, l_t \st 
   l = l_h ++ [\event_z, \event_y] ++ l_t 
   \implies \flowsto(\pi_1(\event_z)^{\pi_2(\event_y)}, \pi_1(\event_y)^{\pi_2(\event_y)})
\end{array}
\end{equation}
%
\begin{equation}
  \event_z \in \eventset^{\asn}, \event_y \in \eventset^{\test}
  \implies \pi_1(\event_z) \in VAR(\pi_1(\event_y))
\end{equation}
%
\begin{equation}
  \event_z \in \eventset^{\test}, \event_y \in \eventset^{\asn}
  \implies \forall z \in VAR(\pi_1(\event_z)) \st \exists i \in\mathbb{N} \st
  \flowsto(z^i, \pi_1(\event_y)^{\pi_2(\event_y)})
\end{equation}
%
\begin{equation}
  \event_z, \event_y \in \eventset^{\test}
  \implies l_h ++ [\event_z, \event_y] ++ l_t \in \kw{dfs}(\trace, c, D)
\end{equation}
\begin{subcase}[ $\event_z, \event_y \in \eventset^{\asn}$ ].
\\
Unfolding $\kw{dfs}(\trace, c, D)$, let $l$ be arbitrary $l \in  \kw{dfs}(\trace, c, D)$, it is sufficient to show 
\[
   \forall \event_z, \event_y \in \eventset^{\asn}, l_h, l_t \st 
   l = l_h ++ [\event_z, \event_y] ++ l_t 
   \implies \flowsto(\pi_1(\event_z)^{\pi_2(\event_y)}, \pi_1(\event_y)^{\pi_2(\event_y)})
\] 
%
Proving by cases of $\event_z \eventeq \event_1 \lor \event_z \eventneq \event_1$.
\begin{subsubcase}[$\event_z \eventneq \event_1$]
Let $\event_z, \event_y \in \eventset^{\asn}, l_h, l_t$ be arbitrary events and lists such that:
\[
  l = l_h ++ [\event_z, \event_y] ++ l_t 
\]
%
Then it is sufficient to show $\flowsto(\pi_1(\event_z)^{\pi_2(\event_y)}, \pi_1(\event_y)^{\pi_2(\event_y)})$.
\\
By $\event_z \neq \event_1$, we have:
\[
  \event_z, \event_y \in (\trace_{ih} \cdot \event_2)
\]
%
Let $\trace_{tl}$ be a subtrace  of $\trace$, such that: 
$\trace[\event_z:] = \cdot \event_z \tracecat \trace_{tl}$, we know $\trace_{tl}$ is also a subtrace  of $\trace_{ih} \cdot \event_2$.
\\
Unfolding $\kw{dfs}(\trace, c, D)$, by $l_h ++ [\event_z, \event_y] ++ l_t  \in\kw{dfs}(\trace, c, D)$, we have:
\[
\begin{array}{l}
  \exists l_{h}' \st l_{h}' ++ [\event_y] ++ l_t \in \kw{dfs}( \trace_{tl}, c, D) \st
  (\event_z \stackrel{\trace[\event_z:]}{\uplus} l_{h}' ++ [\event_y] ++ l_t) = \{[\event_z, \event_y] ++ l_t\} 
  \end{array}
\]
%
Then
we have
\[
  [\event_z, \event_y] ++ l_t 
  \in \kw{dfs}(\trace[\event_z:], c, D)
\]
%
%
By induction hypothesis with subtrace $\trace[\event_z:]$ and $[\event_z, \event_y] ++ l_t 
  \in \kw{dfs}(\trace[\event_z:], c, D)$ we know:
\[
  \flowsto(\pi_1(\event_z)^{\pi_2(\event_z)}, \pi_1(\event_y)^{\pi_2(\event_y)})
\]
This case is proved.
%
\end{subsubcase}
%
\begin{subsubcase}[$\event_z \eventeq \event_1$].
\\
Let $\event_y \in \eventset^{\asn}, l_h, l_t$ be arbitrary events and lists such that:
\[
  l = l_h ++ [\event_z, \event_y] ++ l_t 
\]
%
By $\event_z \eventeq \event_1$, we have $l_h = []$ and:
\[
\begin{array}{l}
  \exists l_{h}' \st l_{h}' ++ [\event_y] ++ l_t \in \kw{dfs}(\trace_{ih}\cdot \event_2, c, D) \st
   (\event_1 \stackrel{\trace}{\uplus} l_{h}' ++ [\event_y] ++ l_t) = \{[\event_1, \event_y] ++ l_t\}
\end{array}
\]
%
Unfolding $(\event_1 \stackrel{\trace}{\uplus} l_{h}' ++ [\event_y] ++ l_t)$, we have:
\[
\begin{array}{l}
  \eventdep^{val}(\event_1, \event_y, \trace[\event_1:\event_y], c, D)
  \\ \quad \land 
  (\forall \event_i \in l_{h}' \st \neg \eventdep^{val} (\event_1, \event_i, \trace[\event_1: \event_i], c, D))
\end{array}
\]
%
To show $\flowsto(\pi_1(\event_1)^{\pi_2(\event_1)}, \pi_1(\event_y)^{\pi_2(\event_y)})$, unfolding $\eventdep^{val}(\event_1, \event_y, \trace[\event_1:\event_y], c, D)$, we have:
\[
\exists \config{c_1, \trace_1 \cdot \event_1} \rightarrow^{*} \config{c_2, \trace_1 \tracecat \trace[\event_1:\event_y]} 
\]
and 
\[
\exists \config{c_1, \trace_1 \cdot \event_1'} \rightarrow^{*} \config{c_2, \trace_1 \tracecat \trace'[\event_1':\event_y']} 
\]
Since $l_{h}'$ is subset of $\trace[\event_1:\event_y] \setminus \{\event_1, \event_y\}$, and 
%
 by unfolding $\kw{dfs}(\kw{dfs}(\trace_{ih}\cdot \event_2, c, D) $, we have 
 $\forall \event \in (\trace[\event_1:\event_y]\setminus \{\event_1, \event_y\}) 
 \land \event \notin l_h'$,
\[
  \neg \eventdep^{val} (\event, \event_y, c, D)
\]
%
Then we know:
\[
  \forall \event \in (\trace[\event_1:\event_y]\setminus \{\event_1, \event_y\}) \st
  \neg \eventdep^{val} (\event_1, \event, c, D) \lor \neg \eventdep^{val} (\event, \event_y, c, D)
\]
\\
%
$\event_1$ is the only possible cause of difference in $\event_y$ and $\event_y'$.
%
\\
%
By inversion Lemma.~\ref{lem:inv_asn}, let $\expr$ or $\qexpr$ be the expression such that:
\[
\config{c_1, \trace_1 \cdot \event_1} \rightarrow^{*} \config{[\assign{\pi_1(\event_y)}{\expr / \query(\qexpr)}]{}^{\pi_2(\event_y)};c_2, \trace_1 \tracecat \trace'} \rightarrow^{asn / query} \config{c_2, \trace_1 \tracecat \trace[\event_1:\event_y]} 
\]
By inversion Lemma.~\ref{lem:inv_a}, 
\[
  \pi_1(\event_1) \in VAR(\expr)
\]
%
By $\flowsto$ definition:
\[
  \flowsto(\pi_1(\event_1)^{\pi_2(\event_1)}, \pi_1(\event_y)^{\pi_2(\event_y)})
\]
%
\end{subsubcase}
%
\end{subcase}
%
\begin{subcase}[ $l_h ++ {[\event_z, \event_b, \event_y]} ++ l_t$ ].
\\
by strong induction on $\trace$,
\[
\begin{array}{l}
  \forall \event_{ih1}, \event_{ih2} \eventin \trace, D \in \dbdom , c \st
  \\ \quad 
   \forall l \in \kw{dfs}(\event_{ih1}, \trace[\event_{ih1}:\event_{ih2}], c, D) \st
   \\ \quad 
   \forall \event_b \in \eventin (\trace \cap \eventset^{\test}), \event_c \in \eventset, l_h, l_t \st 
   l = l_h ++ [ \event_b, \event_c] ++ l_t 
   \implies \forall z \in VAR(\pi_1(\event_b)) \implies \exists i \in \mathbb{N}, \flowsto(z^i, y^j)
   \\
   \implies
   \forall D \in \dbdom , c \st
  \\ \quad 
   \forall l \in \kw{dfs}(\event_1, \trace, c, D) \st
   \\ \quad 
   \forall \event_b \in \eventin (\trace \cap \eventset^{\test}), \event_c \in \eventset, l_h, l_t \st 
   l = l_h ++ [ \event_b, \event_c] ++ l_t 
   \implies \forall z \in VAR(\pi_1(\event_b)) \implies \exists i \in \mathbb{N}, \flowsto(z^i, y^j)
\end{array}
\]
inversion on  $l_h ++ {[\event_z,  \event_b, \event_y]} ++ l_t \in \kw{dfs}(\event_1, \trace, c, D)$, 
\[
  \exists l_{h}' ++ [\event_b, \event_y] ++ l_t, \trace \st
  \eventdep^{val}(\event_z, \event_b, \trace[\event_z: \event_b], c, D)
  \land 
  \neg \eventdep^{val} (\event_z, l_h', \trace[\event_z: l_h'], c, D)
  \land 
  \eventdep^{\ctl} (\event_b, \event_y, c, D)
\]
%
By $\eventdep^{\ctl} (\event_b, \event_y) $, we have:
\[
  [\event_b, \event_y]\in \kw{dfs}(\event_{z}, \trace[\event_{z}:\event_{y}], c, D)
\]
%
By induction hypothesis, we have:
\begin{equation}
\label{ih_ctl}
  \forall z \in VAR(\pi_1(\event_b)) \implies \exists i \in \mathbb{N}, \flowsto(z^i, y^j)
\end{equation}
%
By $\eventdep^{val}(\event_z, \event_b, \trace[\event_z: \event_b], c, D)$, we have:
\[
  [\event_z, \event_b]\in \kw{dfs}(\event_{z}, \trace[\event_{z}:\event_{b}], c, D)
\]
%
By induction hypothesis, we have:
\[
  \pi_1(\event_z) \in VAR(b)
\]
%
By $\flowsto$ definition, we have $\pi_2(\event_z)$ be the label in Eq.~\ref{ih_ctl} s.t.:
\[
  \flowsto(\pi_1(\event_z)^{\pi_2(\event_z)}, y^j)
\]
%
This case is proved
%
\completeness{
\\
By $\neg \eventdep^{val} (\event_z, l_h')$, 
\[
  \forall x \in l_h' \st
  \env \app \trace x = \env \app \trace' x
\]
%
$\forall \event \in \trace \land \event \notin l_h'$, by induction hypothesis on $l_{h}' ++ [\event_y] ++ l_t$, 
\[
  \neg \eventdep^{val} (\event, \event_y, c, D)
\]
%
We know:
\\
%
$\event_z$ is the only possible cause of difference in $\event_b$ and $\event_b'$.
%
By inversion Lemma.~\ref{lem:inv_b}, 
\[
  z \in VAR(b)
\]
%
By $  \eventdep^{\ctl} (\event_b, \event_y)$:
\[
  \forall x \in VAR(b) \st \flowsto(x, y)
\]
i.e.,
\[
  \flowsto(z, y)
\]
}
%
\end{subcase}
%
\begin{subcase}[ $l_h ++ {[\event_z, \event_{b_1}, \cdots, \event_{b_n}, \event_y]} ++ l_t$ ].
\\
inversion on  $l_h ++ {[\event_z,  \event_{b_1}, \cdots, \event_{b_n},\event_y]} ++ l_t$, 
\[
  \exists l_{h}' ++ [ \event_{b_1}, \cdots, \event_{b_n}, \event_y] ++ l_t, \trace \st
  \eventdep^{val}(\event_z, \event_{b_1}, \trace)
  \land 
  \neg \eventdep^{val} (\event_z, l_h')
  \land 
  \eventdep^{\ctl} (\event_{b_1}, \event_{b_2})
  \land 
  \cdots
  \land 
  \eventdep^{\ctl} (\event_{b_n}, \event_y)
\]
%
By $\neg \eventdep^{val} (\event_z, l_h')$, 
\[
  \forall x \in l_h' \st
  \env \app \trace x = \env \app \trace' x
\]
%
$\forall \event \in \trace \land \event \notin l_h'$, by induction hypothesis on $l_{h}' ++ [\event_y] ++ l_t$, 
\[
  \neg \eventdep^{val} (\event, \event_y, c, D)
\]
%
We know:
\\
%
$\event_z$ is the only possible cause of difference in $\event_{b_1}$ and $\event_{b_1}'$.
%
By inversion Lemma.~\ref{lem:inv_b}, 
\[
  z \in VAR(b_1)
\]
%
%
By transitivity of control dependency between testing events in Lemma.~\ref{lem:ctl_trans},
we have:
 $ \eventdep^{\ctl} (\event_{b_1}, \event_y)$:
\[
  \forall x \in VAR(b_1) \st \flowsto(x, y)
\]
i.e.,
\[
  \flowsto(z, y)
\]
%
\end{subcase}
%
\end{case}
%
\end{proof}

\end{document}